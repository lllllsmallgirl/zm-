6.17

# 集控室同步

## 手柄

由于引入了socket.io这个js库，所以继续沿用以下模板

```js
//浏览器端
btn.addEventListener('click',function(){
  console.log('点击××')
  socket.emit('任意起一个函数名'，想要同步的变量)
})
socket.on('刚才起的函数名',function(e1){
  //这里可以写具体的逻辑操作
})

//服务端
socket.on('splecrclick',(e1)=>{
   io.emit('splecrclick',e1);
})
```

在同步集控室车钟手柄的时候，只需传入trmp和tb即可

trmp是由于在推动集控车钟手柄的过程中trmp会随着手柄向前推动的幅度随之变化

tb是用来同步手柄的位置的变量，在这里我监听的动作为mousemove，所以当在一个客户端向上推动手柄时，在另一个已经打开的页面中能够同步的看到手柄被推动





## 工况选择

在工况选择里，我选择新建一个变量sio

当sio=1的时候执行原始工况的代码

当sio=2的时候执行备车完毕的代码

当sio=3的时候执行主机运行的代码



6.18

## 三维机旁

由于机旁应急起动操作比较复杂，所以要同步的变量有很多，再加上二维机旁，代码内部的逻辑就比较混乱，在我尝试写二维机旁的过程中，起动按钮的逻辑一直存在bug，所以打算暂时先不做二维，以后有时间可以重新理一下逻辑。

下面是三维机旁的各部分：

### 1.控制面板

#### 1）起动按钮的mousedown和mouseup

机旁的起动按钮与空气起动相关，在实现同步的过程中，传入了一个新建变量，在返回给各个客户端的函数里，实现了按钮的图片样式的变化，还有空气起动的变量airstart，在这里要重新理一下空气起动的思路：

airstart的初始值为0

按下start按钮进行空气起动，airstart的值变为2

松开按钮有两种可能性：一是转速达到起动转速、二是未达到起动转速

①当转速达到起动转速时，表示空气起动成功，airstart=2

②当转速未达到起动转速时，表示空气起动失败，airstart=1

在calculate.js中的calculate函数中有判断机旁控制的代码片段，如果airstart=1，即空气起动失败了，那么ydx=0，就是油门齿条刻度为0；如果airstart=2，即正在进行空气起动，将lrmp赋值给ydx，lrmp与调油手轮的给油多少有关。

<u>*另外在测试中，当按下stop按钮实现停止操作后，==**必须必须必须将调油手轮调为0！！！**==  否则无法再次起动。*</u>

#### 2）stop按钮

stop按钮比较简单，在原local.js文件里只是将7个变量归零，所以在变量同步的时候只需将7个变量传到各个客户端即可

#### 3）操作部位切换扳手

操作部位切换扳手这一动作本不复杂，但是切换操作部位所带来的影响却很大。

当操作部位从remote切换到local时（点击id为touming3的元素），改变了的首先是与二维机旁所关联的变量lhandle1，还有机旁界面左侧仪表盘上的指示灯光，包括三维机旁的四个界面仪表盘和二维机旁的仪表盘；其次是车钟左下角的当前操作部位指示灯光，（注意：在命名时，山哥把机旁车钟的三个操作部位指示灯分别命名为lbcr、lecr、lloc，但是在集控室和驾驶台的车钟上命名有变化：bbridge、becr、blocal、tbridge、tecr、tlocal）。

当操作部位从local切换到remote时（点击id为touming4的元素），依然是先改变图片样式，实现扳手移动的效果。其余的跟上述同理，在此不再多做赘述。

这一部分的代码原来写的比较复杂，有大量重复代码语句，比较耗费资源，以后有时间可以优化一下该部分。



### 3.调速器切换

#### 1）锁紧手柄

三维锁紧手柄在开发的过程中本身就设置了自身的变量wx，同时把这个值传给了二维机旁的锁紧手柄变量lhandle3x。这两个变量都是起着通过奇偶判断次数的作用，如果是奇数就实现锁紧手柄扳到unlock档位，同时二维机旁的锁紧手柄也随之变化，反之如果是偶数就恢复lock状态

#### 2）手动/遥控切换手轮

三维的手动/遥控切换手轮在开发时设置的与二维不同，二维需要多次点击达到效果，而三维点击一次即可实现效果。在样式和内部逻辑变量上都实现同步，具体实现方法依然是凭借奇偶性来判断打开还是关闭。



### 3.调油手轮

#### 1）加油

判断变量z，将点击加油按钮后z的值返回给各个浏览器端，根据z的1、2、3、4、5、6这六个档位分别再设置lrmp和lwheelx2x的值 

#### 2）减油

同上



### 4.辅车钟

本界面涉及到的只有操控部位指示灯，在操纵部位切换那一部分会详细地讲解







## 气动操纵界面

在气动操纵界面中一共有六个按钮元素，但是并不是点击阀门按钮就会返回变量，要注意监听动作的对象，在点击阀门时会跳出一个自制的对话框，当点击“确定”按钮时才应该返回对应阀门的变量，下面以打开主气动阀为例：

```js
//浏览器端
let valve6 = document.getElementById('valve116Comfirm')
valve6.addEventListener('click',function(){
    console.log('点击主起动阀')
    socket.emit('valve6click',value116x)
})
socket.on('valve6click',function(e1){
    value116x = e1
})

//服务端
socket.on('valve6click',(e1)=>{
   io.emit('valve6click',e1);
})
```





6.19 周六放假呀

6.20周日也放个假吧













